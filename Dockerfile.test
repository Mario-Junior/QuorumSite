# Dockerfile apenas para rodar testes
FROM mcr.microsoft.com/dotnet/sdk:8.0

WORKDIR /src

# Copy project files
COPY QuorumSite.sln .
COPY QuorumSite.csproj .
COPY QuorumSite.Tests/QuorumSite.Tests.csproj ./QuorumSite.Tests/

# Restore dependencies
RUN dotnet restore

# Copy source code
COPY . .

# Criar usu√°rio n√£o-root e ajustar permiss√µes
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /src && \
    mkdir -p /src/TestResults && \
    chown appuser:appuser /src/TestResults
USER appuser

# Run tests with HTML logger - o relat√≥rio ser√° salvo em TestResults/
CMD dotnet test --verbosity normal \
    --logger "console;verbosity=detailed" \
    --logger "html" \
    --results-directory /src/TestResults && \
    echo "\n==========================================" && \
    echo "‚úÖ Relat√≥rio HTML gerado com sucesso!" && \
    echo "üìÑ Arquivo: TestResults/test-report.html" && \
    echo "üåê Abra o arquivo no seu navegador" && \
    echo "==========================================" || \
    (echo "‚ùå Erro ao gerar relat√≥rio" && exit 1)
